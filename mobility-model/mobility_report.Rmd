---
output: pdf_document
header-includes:
  - \usepackage{pxfonts} 
params:
  results_path: temp 
  # results_file: fr_64426766_41_mob_results.rds 
  # fit_file: fr_64426766_41_mob.RData
  # country_code: FR
  results_file: se_64349420_108_mob_results.rds
  fit_file: se_64349420_108_mob.RData
  country_code: SE
  subnat_hier: true
  prior: false 
  multi_singletons: false 
---

```{r setup, echo=FALSE, include=FALSE}
root_path <- "."

if (!interactive()) {
  source(file.path("renv", "activate.R"))
}

library(magrittr)
library(tidyverse)
library(cowplot)
library(ggridges)
library(haven)
library(latex2exp)
library(rstan)

ggplot2::theme_set(theme_minimal())

knitr::opts_chunk$set(echo = FALSE)
```

```{r}
source(file.path("mobility-model", "mob_util.R"))
```


```{r}
results <- read_rds(file.path(params$results_path, params$results_file))

if (!params$multi_singletons) {
  results %<>% 
    filter(fct_match(country_code, params$country_code))
  
  country_name <- results$country_name %>% unique()
} else {
  country_name <- "Multiple Countries"
}
```

---
title: `r country_name`
---

```{r, results='asis'}
if (params$multi_singletons) {
  cat("Countries:\n\n")
  cat(str_c("* ", results$country_name, collapse = "\n"))
}
```


## Data

```{r obs-cases, fig.width=15}
results %>%
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_data(par = "new_cases", use_date = TRUE, use_free_y_scale = TRUE, use_bar = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  labs(title = "New Cases") 
```

```{r obs-deaths, fig.width=15}
results %>%
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_data(par = "new_deaths", use_date = TRUE, use_free_y_scale = TRUE, use_bar = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region")  +
  labs(title = "New Deaths") 
```

```{r mob-plot, fig.height=6, fig.width=12}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_data(par = c("g_residential", "g_transit_stations", "average_mob"), use_date = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  labs(title = "Mobility Data") +
  NULL
```

## Analysis

Number of divergent transitions = `r first(results$divergent_trans)`

Maximum $\hat{R}$ = `r first(results$max_rhat)`

Minimum Bulk ESS = `r first(results$min_ess_bulk)`

Minimum Tail ESS = `r first(results$min_ess_tail)`

```{r R0-plot, fig.width=10}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_subnat_ci(par = "R0") + 
  labs(title = TeX("R_{0,m}"))
```

```{r Rt-plot, fig.height=6, fig.width=12}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_ci(par = c("Rt", "Rt_adj"), use_date = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(title = TeX("R_{t,m}")) 
```

Contact rate function: \[ cr(t; t^*, \lambda_j, \kappa) = \lambda_j + \frac{1 - \lambda_j}{1 + \exp(\kappa (t - t^*))} \]
where 
\begin{align*}
\lambda_j &\sim \mathtt{Beta}(3, 1) \\
\kappa &\sim \mathtt{NegHalfNormal}(0, 1).
\end{align*}

```{r param-trend, fig.height=6, fig.width=12}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_ci(par = "trend", use_date = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  labs(title = TeX("Contact Rate")) 
```

```{r mobility-effect-plot, fig.height=6, fig.width=12}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_ci(par = "mobility_effect", use_date = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  geom_hline(yintercept = 1, linetype = "dotted") +
  labs(title = "Mobility effect") 
```

```{r adj-factor-plot, fig.height=6, fig.width=12}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_day_ci(par = "adj_factor", use_date = TRUE, facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  labs(title = TeX("S_{t,m}")) 
```

Mobility linear model: $\beta_1 \cdot X_\text{residential} + \beta_2 \cdot X_\text{transit} + \beta_3 \cdot X_\text{average}$.

```{r beta, fig.width=10}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_subnat_ci(beta = TRUE) + 
  labs(title = TeX("$\\beta$"))
```

```{r post-deaths, fig.width=14}
if (!params$prior) {
  results %>% 
    select(country_code, country_name, country_data) %>% 
    unnest(country_data) %>% 
    plot_post_deaths()
}
```

```{r imputed-cases, fig.width=10}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_subnat_ci(par = "imputed_cases") + 
  labs(title = TeX("Imputed Cases"))
```


```{r cases, fig.width=10}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_pred_vs_obs("new_cases", "new_cases", facet_by = if (params$multi_singletons) "country_name" else "sub_region") +
  labs(title = "New Cases", subtitle = "predicted vs observed")
```

```{r ifr, fig.width=10}
results %>% 
  select(country_code, country_name, country_data) %>% 
  unnest(country_data) %>% 
  plot_subnat_ci(par = "ifr") + 
  labs(title = TeX("IFR"))
```

```{r, results='asis'}
if (!is_null(params$fit_file)) {
  do_diag <- TRUE
  cat("\n# Diagnostics\n")
} else {
  do_diag <- FALSE
}
```

```{r diag-setup, include=FALSE, eval=do_diag}
library(bayesplot)
color_scheme_set("darkgray")
  
load(file.path(params$results_path, params$fit_file))

mob_posterior <- as.array(mob_fit)

mob_sub_iter <- sample(nrow(mob_posterior), 200) # Shrink it a little

mob_posterior %<>% magrittr::extract(mob_sub_iter, ,)

mob_lp <- log_posterior(mob_fit) %>%
  filter(Iteration %in% mob_sub_iter)
mob_np <- nuts_params(mob_fit) %>%
  filter(Iteration %in% mob_sub_iter)
```

```{r pairs, fig.width=14, fig.height=10, eval=do_diag}
pairs_pars <- c(
  "overdisp_deaths", "mean_deaths[10]", "imputed_cases[1]",
  "toplevel_log_R0", 
  "beta_toplevel[2]", 
  "ifr_noise[1]",
  "trend_lambda[1]", "toplevel_trend_kappa"
)

pairs_trans <- lst(
  overdisp_deaths = "log",
  "mean_deaths[10]" = "log",
  "imputed_cases[1]" = "log",
  "trend_lambda[1]" = "log", "toplevel_trend_kappa" = function(kappa) log(-kappa),
  "ifr_noise[1]" = "log"
)

if (params$subnat_hier && !params$multi_singletons) {
  pairs_pars %<>% c(
    "subnational_effect_log_R0_raw[1]", "subnational_effect_log_R0_sd[1]",
    "beta_subnational_raw[2,1]", "beta_subnational_sd[2,1]"
  ) 
  
  pairs_trans %<>% list_modify(
    "subnational_effect_log_R0_sd[1]" = "log",
    "beta_subnational_sd[2,1]" = "log"
  )
}

mcmc_pairs(
  mob_posterior, np = mob_np,
  pars = pairs_pars,
  transformations = pairs_trans,
  off_diag_args = list(size = 0.75)
  # np_style = pairs_style_np(div_size = 2, div_shape = 16, td_alpha = 0.1)
)
```

