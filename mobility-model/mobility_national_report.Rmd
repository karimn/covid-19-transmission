---
title: "Results for all countries"
output: pdf_document
---

```{r setup}
library(magrittr)
library(tidyverse)
library(ggridges)
library(haven)
library(rstan)

source(file.path("..", "util.R"))

knitr::opts_chunk$set(fig.width=14, fig.height = 10)

ggplot2::theme_set(theme_minimal())
```


```{r}
library(tidyverse)
results <- readRDS("../data/mobility/results/clean/lite_merged.rds")
```


# Mortality data

```{r mortality}
results %>% 
  select(country_name, sub_region, daily_data, population) %>% 
  unnest(daily_data) %>%
  group_by(country_name, date) %>%
  summarise(deaths = sum(cum_deaths),
            deaths_per100k = 1e05*sum(cum_deaths)/sum(population),
            .groups = "keep") %>%
  filter(deaths > 10) %>%
  ggplot(aes(x=date, y=deaths_per100k, color = country_name)) + geom_line() + scale_y_log10()
```


# Mobility data

```{r mobility}
results %>% 
  select(country_name, sub_region, daily_data, population) %>% 
  unnest(daily_data) %>%
  group_by(country_name, date) %>%
  summarise(mob = mean(g_transit_stations + g_workplaces + g_retail_and_recreation)) %>%
  ggplot(aes(x=date, y=mob, color = country_name)) + geom_line()
```


# R0 and imputed cases

```{r params}
results %>% 
  unnest(param_results) %>%
  filter(parameter %in% c("R0", "imputed_cases")) %>%
  mutate(mean = ifelse(parameter == "imputed_cases", log(mean), mean)) %>%
  ggplot(aes(y = country_name, x = mean, color = country_name)) + 
  geom_jitter() +
  theme(legend.position = "none") +
  facet_wrap( ~ parameter, ncol = 3, scales = "free")
```

# Betas with regions

```{r betas}
results %>% 
  unnest(beta_results) %>%
  ggplot(aes(y = country_name, x = mean, color = country_name)) + 
  geom_jitter() +
  theme(legend.position = "none") +
  facet_wrap( ~ coef_index, ncol = 3, scales = "free")
```
